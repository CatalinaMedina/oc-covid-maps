---
title: "OC Covid Maps"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  fig.align = "center",
  message = FALSE,
  warning = FALSE
)
```


```{r libraries}
library(tidyverse)
library(rgdal)
library(broom)
library(here)
library(lubridate)
library(viridis)
library(TTR)
library(ckanr)

source(here("map-functions.R"))
```


```{r actual-maps}
# Downloading data and shape file takes about 30 seconds
map_data_by_zip <- prep_map_zip_data()
map_data_by_city <- prep_map_city_data()


map_cases(
  map_data_list = map_data_by_city, 
  geog_level = "city",
  start_date = as.Date("2021-02-15"), 
  end_date = as.Date("2021-02-21")
)

map_cases(
  map_data_list = map_data_by_zip, 
  geog_level = "zip",
  start_date = as.Date("2021-02-15"), 
  end_date = as.Date("2021-02-21")
)

map_tests(
  map_data_list = map_data_by_city, 
  start_date = as.Date("2021-02-15"),
  geog_level = "city",
  end_date = as.Date("2021-02-21")
)

map_tests(
  map_data_list = map_data_by_zip, 
  geog_level = "zip",
  start_date = as.Date("2021-02-15"), 
  end_date = as.Date("2021-02-21")
)

map_per_pos(
  map_data_list = map_data_by_city, 
  geog_level = "city",
  start_date = as.Date("2021-02-15"), 
  end_date = as.Date("2021-02-21")
)

map_per_pos(
  map_data_list = map_data_by_zip, 
  geog_level = "zip",
  start_date = as.Date("2021-02-15"), 
  end_date = as.Date("2021-02-21")
)
```


```{r map-oc-blank-w-zips}
oc_data <- map_data_by_zip$oc_data

# load and work shp file
shp <- map_data_by_zip$shp
  
shp_zip <- subset(shp, KEY_ %in% oc_data$zip)
shp_tidy <- tidy(shp_zip, region = "KEY_")  
    
shp_label <- shp_tidy %>% 
    group_by(id) %>% 
    summarize(long = mean(range(long)), lat = mean(range(lat)))
  

ggplot(shp_tidy, mapping = aes(x = long, y = lat, group = group)) +
  geom_polygon(color = "black", fill = NA) +
  theme_void() +
  geom_text(
    data = shp_label,
    mapping = aes(z = long, y = lat, label = id, group = NA),
    cex = 2, 
    color = "black"
  )


################
oc_data <- map_data_by_city$oc_data

# load and work shp file
shp <- map_data_by_zip$shp
  
shp_zip <- subset(shp, NAME %in% oc_data$city)
shp_tidy <- tidy(shp_zip, region = "NAME")  
    
shp_label <- shp_tidy %>% 
    group_by(id) %>% 
    summarize(long = mean(range(long)), lat = mean(range(lat)))
  

ggplot(shp_tidy, mapping = aes(x = long, y = lat, group = group)) +
  geom_polygon(color = "black", fill = NA) +
  theme_void() +
  geom_text(
    data = shp_label,
    mapping = aes(z = long, y = lat, label = id, group = NA),
    cex = 2, 
    color = "black"
  )
```




